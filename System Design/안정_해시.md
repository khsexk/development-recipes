# 안정 해시 

## 해시 키 재배치 문제

- N개의 캐시 서버가 있을 때, 서버들에게 부하를 균등하게 나누는 보편적인 방법은 `해시 함수`를 사용하는 것

```
serverIndex = hash(key) % N
```

### 단점

- Server Pool의 크기가 고정돼 있을 때, 균등히 동작
- 서버 장애로 새로운 서버가 추가 또는 기존 서버가 삭제될 경우 문제가 생김
- 해당 서버에 존재하던 해시키가 사라지고, 엉뚱한 서버로 접속해 `대규모 캐시 미스` 발생

## 안정 해시 (Consistent Hash)

- 해시 테이블의 크기가 조정될 때, 평균적으로 `k / n`개의 키만 재배치하는 해시 기술
  - k: 키의 개수
  - n: 슬롯의 개수
- 해시 공간의 양쪽을 구부려 접으면 `해시 링`(hash ring)이 만들어짐
  - `균등 분포 해시 함수`를 활용하여 해시 링 위에 해시 서버가 배치됨
  - 해시 링 위에 캐시할 키들이 배치됨
- 서버 조회: 해당 키로부터 `시계 방향`으로 링을 탐색해 나가면서 만나는 첫번째 서버

### 문제

- 파티션의 크기를 균등하게 유지하는게 불가능
  - 서버가 추가 및 삭제되면 파티션의 크기가 불균등해짐
- 키의 균등 분포를 달성하기 어려움
  - 한쪽에만 키가 몰릴 수 있음

## 가상 노드

- 실제 노드 또는 서버를 `가리키는` 노드
- 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있음
- 가상 노드의 개수를 늘리면 표준 편차가 작아져 키의 분포도는 점점 균등해짐
  - 가상 노드가 `200`개인 경우, 표준편차 값은 평균의 `5%`
  - 가상 노드가 `100`개인 경우, 표준편차 값은 평균의 `10%`
- 가상 노드이 개수를 더 늘리면 표준 편차의 값은 더 떨어짐
- 하지만 가상 노드 데이터를 저장할 공간이 더 많이 필요해지게 됨
